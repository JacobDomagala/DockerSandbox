ARG BASE_IMAGE=22.04
FROM ubuntu:${BASE_IMAGE} AS build

RUN apt-get update && \
    DEBIAN_FRONTEND=noninteractive apt-get install -y \
    cmake g++ build-essential ccache && \
    rm -rf /var/lib/apt/lists/*

ENV CCACHE_DIR=/build/.ccache \
    CCACHE_COMPILERCHECK=content

ARG BASE_IMAGE

RUN --mount=type=bind,target=/DockerSandbox,rw \
    mkdir -p /build/.ccache && \
    if [ -d /DockerSandbox/tmp/ccache-data ]; then \
        echo "COPYING CASHE!" && \
        ls -R /DockerSandbox/tmp/ccache-data/ && \
        cp -a /DockerSandbox/tmp/ccache-data/. /build/.ccache/ ; \
    fi && \
    /DockerSandbox/ci/build.sh /DockerSandbox /build && \
    cp -a /build/.ccache/. /DockerSandbox/tmp/ccache-data/ && \
    ls -R /build/.ccache/ && \
    ls -R /DockerSandbox/tmp/ccache-data/

